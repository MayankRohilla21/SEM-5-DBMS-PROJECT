{% extends "base.html" %}

{% block title %}Attachments - Job Application Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Attachments</h2>
    <div>
        <a class="btn btn-secondary"
            href="{{ url_for('attachments', sort='id_desc' if sort=='id_asc' else 'id_asc') }}">Sort by ID {% if
            sort=='id_asc' %}▲{% elif sort=='id_desc' %}▼{% endif %}</a>
        <button class="btn btn-primary" onclick="toggleModal('addAttachmentModal')">Add Attachment</button>
    </div>
</div>

<table class="data-table">
    <thead>
        <tr>
            <th>Attachment ID</th>
            <th>File Name</th>
            <th>Type</th>
            <th>File URL</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% if attachments %}
        {% for attachment in attachments %}
        <tr>
            <td>{{ attachment.AttachmentID }}</td>
            <td>{{ attachment.File_Name }}</td>
            <td><span class="status-badge">{{ attachment.Type }}</span></td>
            <td><a href="{{ attachment.File_url }}" target="_blank">View</a></td>
            <td>
                <button class="btn btn-sm"
                    onclick="editAttachment('{{ attachment.AttachmentID }}', '{{ attachment.File_Name }}', '{{ attachment.File_url }}', '{{ attachment.Type }}')">Edit</button>
                <form method="POST" action="{{ url_for('delete_attachment', attachment_id=attachment.AttachmentID) }}"
                    style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger"
                        onclick="return confirm('Delete this attachment?')">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
            <td colspan="5" style="text-align: center; padding: 20px;">
                No attachments found. Click "Add Attachment" to add one.
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>

<!-- Add Attachment Modal -->
<div id="addAttachmentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="toggleModal('addAttachmentModal')">&times;</span>
        <h3>Add Attachment</h3>
        <form method="POST" action="{{ url_for('add_attachment') }}">
            <input type="text" name="attachment_id" placeholder="Attachment ID" required>
            <input type="text" name="file_name" placeholder="File Name" required>
            <input type="url" name="file_url" placeholder="File URL" required>
            <select name="file_type" required>
                <option value="Resume">Resume</option>
                <option value="Cover Letter">Cover Letter</option>
                <option value="Portfolio">Portfolio</option>
                <option value="Others">Others</option>
            </select>
            <button type="submit" class="btn btn-primary">Add Attachment</button>
        </form>
    </div>
</div>

<script>
    function toggleModal(id) {
        document.getElementById(id).classList.toggle('show');
    }

    function editAttachment(id, fileName, fileUrl, fileType) {
        const row = event.target.closest('tr');

        // Escape values for HTML
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        const escapedId = escapeHtml(id);
        const escapedFileName = escapeHtml(fileName);
        const escapedFileUrl = escapeHtml(fileUrl);
        const escapedFileType = escapeHtml(fileType);

        row.innerHTML = `
        <td>${escapedId}</td>
        <td>
            <input type="text" value="${escapedFileName}" name="file_name" required style="width:95%;" form="editForm_${escapedId}">
        </td>
        <td>
            <select name="file_type" required style="width:100%;" form="editForm_${escapedId}" id="file_type_${escapedId}">
                <option value="Resume" ${fileType.trim() === 'Resume' ? 'selected' : ''}>Resume</option>
                <option value="Cover Letter" ${fileType.trim() === 'Cover Letter' ? 'selected' : ''}>Cover Letter</option>
                <option value="Portfolio" ${fileType.trim() === 'Portfolio' ? 'selected' : ''}>Portfolio</option>
                <option value="Others" ${fileType.trim() === 'Others' ? 'selected' : ''}>Others</option>
            </select>
        </td>
        <td>
            <input type="url" value="${escapedFileUrl}" name="file_url" required style="width:95%;" form="editForm_${escapedId}">
        </td>
        <td>
            <form method="POST" action="/attachments/edit/${escapedId}" id="editForm_${escapedId}">
                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                <button type="button" class="btn btn-sm" onclick="window.location.reload()">Cancel</button>
            </form>
        </td>
    `;
    }
</script>
{% endblock %}