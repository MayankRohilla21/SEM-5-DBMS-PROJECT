{% extends "base.html" %}

{% block title %}Companies - Job Application Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Companies</h2>
    <div>
        <a class="btn btn-secondary" href="{{ url_for('companies', sort='id_desc' if sort=='id_asc' else 'id_asc') }}">
            Sort by ID {% if sort=='id_asc' %}▲{% elif sort=='id_desc' %}▼{% endif %}
        </a>
        <button class="btn btn-primary" onclick="toggleModal('addCompanyModal')">Add New Company</button>
    </div>
</div>

<table class="data-table">
    <thead>
        <tr>
            <th>Company ID</th>
            <th>Company Name</th>
            <th>Website</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for company in companies %}
        <tr>
            <td>{{ company.CompanyID }}</td>
            <td>{{ company.Company_Name }}</td>
            <td><a href="{{ company.Website }}" target="_blank">{{ company.Website }}</a></td>
            <td>
                <button class="btn btn-sm"
                    onclick="editCompany('{{ company.CompanyID }}', '{{ company.Company_Name }}', '{{ company.Website }}')">
                    Edit
                </button>
                <form method="POST" action="{{ url_for('delete_company', company_id=company.CompanyID) }}"
                    style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger"
                        onclick="return confirm('Delete this company?')">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Add Company Modal -->
<div id="addCompanyModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="toggleModal('addCompanyModal')">&times;</span>
        <h3>Add New Company</h3>
        <form method="POST" action="{{ url_for('add_company') }}">
            <input type="text" name="company_id" placeholder="Company ID" required>
            <input type="text" name="name" placeholder="Company Name" required>
            <input type="url" name="website" placeholder="Website URL" required>
            <button type="submit" class="btn btn-primary">Add Company</button>
        </form>
    </div>
</div>

<!-- ✅ Corrected Script Section -->
<script>
    function toggleModal(id) {
        document.getElementById(id).classList.toggle('show');
    }

    function editCompany(id, name, website) {
        const row = event.target.closest('tr');
        row.innerHTML = `
        <td>${id}</td>
        <td><input type="text" id="edit-name-${id}" value="${name}" required></td>
        <td><input type="url" id="edit-website-${id}" value="${website}" required></td>
        <td>
            <button class="btn btn-sm btn-success" onclick="saveCompany('${id}')">Save</button>
            <button class="btn btn-sm btn-secondary" onclick="location.reload()">Cancel</button>
        </td>
    `;
    }

    function saveCompany(id) {
        const name = document.getElementById(`edit-name-${id}`).value.trim();
        const website = document.getElementById(`edit-website-${id}`).value.trim();

        if (!name || !website) {
            alert("Company Name and Website are required.");
            return;
        }

        const form = document.createElement("form");
        form.method = "POST";
        form.action = `/companies/edit/${id}`;

        const nameInput = document.createElement("input");
        nameInput.type = "hidden";
        nameInput.name = "name";
        nameInput.value = name;

        const websiteInput = document.createElement("input");
        websiteInput.type = "hidden";
        websiteInput.name = "website";
        websiteInput.value = website;

        form.appendChild(nameInput);
        form.appendChild(websiteInput);
        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}